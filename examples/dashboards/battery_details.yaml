# EG4 Web Monitor - Battery Details Dashboard
#
# Detailed battery monitoring including cell voltage aggregates,
# temperatures, and health metrics
#
# NOTE: The EG4 web monitoring API provides aggregate cell voltage data
# (max/min/delta) but does NOT expose individual cell voltages (1-16).
# This is an upstream API limitation.
#
# To use: Copy this configuration to your Lovelace dashboard
# Adjust entity IDs to match your inverter serial numbers

type: vertical-stack
cards:
  # Battery Overview
  - type: horizontal-stack
    cards:
      - type: gauge
        entity: sensor.eg4_flexboss21_1234567890_battery_soc
        name: State of Charge
        min: 0
        max: 100
        needle: true
        severity:
          green: 60
          yellow: 30
          red: 0
      - type: gauge
        entity: sensor.eg4_flexboss21_1234567890_battery_1_soh
        name: State of Health
        min: 0
        max: 100
        needle: true
        severity:
          green: 80
          yellow: 60
          red: 0

  # Battery Metrics
  - type: entities
    title: Battery System
    show_header_toggle: false
    entities:
      - entity: sensor.eg4_flexboss21_1234567890_battery_power
        name: Power
        icon: mdi:battery-charging
      - entity: sensor.eg4_flexboss21_1234567890_battery_voltage
        name: Voltage
        icon: mdi:lightning-bolt
      - entity: sensor.eg4_flexboss21_1234567890_battery_current
        name: Current
        icon: mdi:current-dc
      - type: divider
      - entity: sensor.eg4_flexboss21_1234567890_battery_1_temperature
        name: Temperature
        icon: mdi:thermometer
      - entity: sensor.eg4_flexboss21_1234567890_battery_1_cycle_count
        name: Cycle Count
        icon: mdi:counter

  # Individual Battery 1 Details
  - type: entities
    title: Battery 1 - Cell Voltage Analysis
    show_header_toggle: false
    entities:
      - entity: sensor.eg4_flexboss21_1234567890_battery_1_voltage
        name: Pack Voltage
      - entity: sensor.eg4_flexboss21_1234567890_battery_1_current
        name: Pack Current
      - entity: sensor.eg4_flexboss21_1234567890_battery_1_power
        name: Pack Power
      - type: divider
      - entity: sensor.eg4_flexboss21_1234567890_battery_1_max_cell_voltage
        name: Max Cell Voltage
        icon: mdi:arrow-up-bold
      - entity: sensor.eg4_flexboss21_1234567890_battery_1_min_cell_voltage
        name: Min Cell Voltage
        icon: mdi:arrow-down-bold
      - entity: sensor.eg4_flexboss21_1234567890_battery_1_cell_voltage_delta
        name: Cell Voltage Delta (Imbalance)
        icon: mdi:delta
      - type: divider
      - entity: sensor.eg4_flexboss21_1234567890_battery_1_max_cell_voltage_num
        name: Cell # with Max Voltage
        icon: mdi:numeric
      - entity: sensor.eg4_flexboss21_1234567890_battery_1_min_cell_voltage_num
        name: Cell # with Min Voltage
        icon: mdi:numeric

  # Cell Temperature Details
  - type: entities
    title: Battery 1 - Cell Temperature Analysis
    show_header_toggle: false
    entities:
      - entity: sensor.eg4_flexboss21_1234567890_battery_1_max_cell_temperature
        name: Max Cell Temperature
        icon: mdi:thermometer-high
      - entity: sensor.eg4_flexboss21_1234567890_battery_1_min_cell_temperature
        name: Min Cell Temperature
        icon: mdi:thermometer-low
      - entity: sensor.eg4_flexboss21_1234567890_battery_1_cell_temp_delta
        name: Cell Temperature Delta
        icon: mdi:delta

  # Cell Voltage Chart - Using available aggregate data
  - type: custom:apexcharts-card
    header:
      show: true
      title: Cell Voltage Range (6h)
    graph_span: 6h
    series:
      - entity: sensor.eg4_flexboss21_1234567890_battery_1_max_cell_voltage
        name: Max Cell
        color: green
      - entity: sensor.eg4_flexboss21_1234567890_battery_1_min_cell_voltage
        name: Min Cell
        color: blue
      - entity: sensor.eg4_flexboss21_1234567890_battery_1_cell_voltage_delta
        name: Delta
        color: red
        y_axis: secondary
    yaxis:
      - id: primary
        min: 3.0
        max: 3.6
        decimals: 3
      - id: secondary
        opposite: true
        min: 0
        max: 0.1
        decimals: 3

  # Battery Temperature History
  - type: custom:apexcharts-card
    header:
      show: true
      title: Battery Temperature (24h)
    graph_span: 24h
    series:
      - entity: sensor.eg4_flexboss21_1234567890_battery_1_max_cell_temperature
        name: Max Temp
        color: red
      - entity: sensor.eg4_flexboss21_1234567890_battery_1_min_cell_temperature
        name: Min Temp
        color: blue

  # Battery Power/SOC Chart
  - type: custom:apexcharts-card
    header:
      show: true
      title: Battery Power & SOC (7 days)
    graph_span: 7d
    series:
      - entity: sensor.eg4_flexboss21_1234567890_battery_power
        name: Power (W)
        yaxis_id: power
      - entity: sensor.eg4_flexboss21_1234567890_battery_soc
        name: SOC (%)
        yaxis_id: soc
    yaxis:
      - id: power
        min: -5000
        max: 5000
      - id: soc
        opposite: true
        min: 0
        max: 100

  # Battery Health Info Card
  - type: markdown
    title: Cell Voltage Health Guide
    content: |
      **Cell Voltage Delta (Imbalance) Interpretation:**
      - **< 0.020V** - Excellent balance
      - **0.020V - 0.050V** - Good balance
      - **0.050V - 0.100V** - Monitor closely
      - **> 0.100V** - Consider top balancing

      *Note: The EG4 API provides aggregate cell data (max/min/delta)
      but does not expose individual cell voltages.*

  # Battery Controls
  - type: entities
    title: Battery Configuration
    show_header_toggle: false
    entities:
      - entity: number.eg4_flexboss21_1234567890_battery_low_soc_limit
        name: Low SOC Limit
      - entity: number.eg4_flexboss21_1234567890_battery_high_soc_limit
        name: High SOC Limit
      - entity: switch.eg4_flexboss21_1234567890_battery_equalization
        name: Battery Equalization
      - entity: button.eg4_flexboss21_1234567890_battery_1_refresh_data
        name: Refresh Battery Data
